<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Discord Group Clean-up</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #36393f; color: white; }
        .container { max-width: 600px; margin: auto; background: #2f3136; padding: 20px; border-radius: 8px; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: none; box-sizing: border-box; }
        input { background: #40444b; color: white; }
        button { background: #5865f2; color: white; font-weight: bold; cursor: pointer; }
        button:hover { background: #4752c4; }
        button:disabled { background: #4f545c; cursor: not-allowed; }
        #log { background: #202225; padding: 15px; height: 250px; overflow-y: scroll; font-family: monospace; font-size: 12px; border-radius: 4px; }
        .err { color: #f04747; }
        .suc { color: #43b581; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Discord グループDM一括整理</h3>
        <p style="font-size: 0.8em; color: #b9bbbe;">※指定した名前と**完全に一致**するグループからのみ離脱します。</p>
        
        <label>1. Token</label>
        <input type="password" id="token" placeholder="ここにトークンを貼り付け">
        
        <label>2. 対象のグループ名</label>
        <input type="text" id="targetName" placeholder="例: 迷惑グループA">
        
        <button id="runBtn">実行する</button>

        <div id="log">ログがここに表示されます...</div>
    </div>

    <script>
        const logBox = document.getElementById('log');
        const print = (txt, cls='') => {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `${new Date().toLocaleTimeString()}: ${txt}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        };

        document.getElementById('runBtn').addEventListener('click', async () => {
            const token = document.getElementById('token').value.trim();
            const target = document.getElementById('targetName').value.trim();
            
            if(!token || !target) return alert('入力が足りません');
            document.getElementById('runBtn').disabled = true;
            logBox.innerHTML = '';

            try {
                print('データ取得中...');
                const res = await fetch('https://discord.com/api/v9/users/@me/channels', {
                    headers: { 'Authorization': token }
                });

                const data = await res.json();

                // 取得失敗のチェック
                if (!Array.isArray(data)) {
                    print(`❌ 失敗: ${data.message || 'トークンが不正です'}`, 'err');
                    document.getElementById('runBtn').disabled = false;
                    return;
                }

                // 名前が一致するグループDM(type:3)を抽出
                const targets = data.filter(c => c.type === 3 && (c.name === target));
                
                print(`対象グループを ${targets.length} 件見つけました。`);

                for (const g of targets) {
                    print(`離脱中: ${g.id}...`);
                    const delRes = await fetch(`https://discord.com/api/v9/channels/${g.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': token }
                    });

                    if (delRes.ok) {
                        print(`✅ 成功: ${g.id}`, 'suc');
                    } else {
                        const errJson = await delRes.json();
                        print(`❌ 失敗: ${errJson.message}`, 'err');
                    }
                    // 安全のため4秒待機
                    await new Promise(r => setTimeout(r, 2000));
                }
                print('すべての処理が完了しました。');
            } catch (e) {
                print('エラー: ' + e.message, 'err');
            }
            document.getElementById('runBtn').disabled = false;
        });
    </script>
</body>
</html>
