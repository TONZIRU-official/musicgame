<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Finger Gunner</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; }
    canvas { position: absolute; transform: scaleX(-1); width: 100vw; height: 100vh; object-fit: cover; }
    #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: #fff; z-index: 10; pointer-events: none; }
    #ammo { position: absolute; bottom: 20px; right: 20px; font-size: 40px; color: #ff0; }
    #crosshair { position: absolute; width: 40px; height: 40px; border: 2px solid #f00; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; display: none; }
    #crosshair::after { content: ''; position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: #f00; border-radius: 50%; transform: translate(-50%, -50%); }
  </style>
</head>
<body>

<div id="ui">
  <div id="score" style="font-size: 30px;">SCORE: 0</div>
  <div id="ammo">BULLETS: 10</div>
</div>
<div id="crosshair"></div>

<video id="input_video" style="display:none;"></video>
<canvas id="output_canvas"></canvas>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const crosshair = document.getElementById('crosshair');

  let score = 0;
  let ammo = 10;
  let enemies = [];
  let frameCount = 0;
  let lastShootTime = 0;

  function spawnEnemy() {
    enemies.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      r: 30 + Math.random() * 20,
      hp: 1
    });
  }

  function onResults(results) {
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      const landmarks = results.multiHandLandmarks[0];
      
      // 指鉄砲の判定（親指と人差し指が立っていて、中指以降が曲がっている）
      const isIndexUp = landmarks[8].y < landmarks[6].y;
      const isThumbUp = landmarks[4].y < landmarks[3].y;
      const isMiddleDown = landmarks[12].y > landmarks[10].y;

      if (isIndexUp && isThumbUp && isMiddleDown) {
        const x = (1 - landmarks[8].x) * window.innerWidth; // 反転考慮
        const y = landmarks[8].y * window.innerHeight;

        crosshair.style.display = 'block';
        crosshair.style.left = x + 'px';
        crosshair.style.top = y + 'px';

        // 発射（0.3秒間隔）
        const now = Date.now();
        if (now - lastShootTime > 300 && ammo > 0) {
          shoot(x, y);
          lastShootTime = now;
        }
      } else {
        crosshair.style.display = 'none';
        // 手を握ったらリロード
        if (isMiddleDown && !isIndexUp) {
          ammo = 10;
          document.getElementById('ammo').innerText = "BULLETS: " + ammo;
        }
      }
    }

    // 敵の描画と更新
    if (frameCount % 60 === 0) spawnEnemy();
    enemies.forEach((e, i) => {
      canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.6)';
      canvasCtx.beginPath();
      canvasCtx.arc(window.innerWidth - e.x, e.y, e.r, 0, Math.PI*2); // 反転描画
      canvasCtx.fill();
      e.r += 0.2;
      if (e.r > 150) { enemies.splice(i, 1); score = Math.max(0, score - 50); }
    });

    frameCount++;
    canvasCtx.restore();
  }

  function shoot(x, y) {
    ammo--;
    document.getElementById('ammo').innerText = "BULLETS: " + ammo;
    
    // 当たり判定（反転しているので注意）
    const targetX = x;
    enemies.forEach((e, i) => {
      const dist = Math.hypot(e.x - targetX, e.y - y);
      if (dist < e.r) {
        enemies.splice(i, 1);
        score += 100;
        document.getElementById('score').innerText = "SCORE: " + score;
      }
    });
  }

  const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
  hands.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 1280, height: 720
  });
  camera.start();
</script>
</body>
</html>
