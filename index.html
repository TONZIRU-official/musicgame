<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Finger Balance - Full Vision</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        
        /* カメラをはっきり表示（反転させて鏡のように） */
        #input_video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
        }
        
        /* ゲームキャンバスを前面に配置 */
        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 2; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        .stats { 
            color: #fff; font-size: 32px; font-weight: bold; 
            text-shadow: 0 0 10px #000, 0 0 5px #0ff; 
        }

        #ui-center { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; pointer-events: auto; z-index: 3;
        }

        #msg { 
            font-size: 60px; color: #fff; 
            text-shadow: 0 0 20px #f0f, 0 0 10px #000; margin-bottom: 20px; 
        }

        button { 
            background: #0ff; color: #000; border: none; padding: 15px 40px; 
            font-size: 24px; font-weight: bold; cursor: pointer; border-radius: 50px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8); transition: 0.2s;
        }
        button:hover { transform: scale(1.1); background: #fff; }

        #loading { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #0ff; font-size: 24px; z-index: 4; text-shadow: 0 0 10px #000;
        }
    </style>
</head>
<body>
    <div id="loading">カメラを起動中...</div>
    <video id="input_video" playsinline></video>
    <canvas id="canvas"></canvas>
    
    <div id="overlay">
        <div class="stats">
            <div>TIME: <span id="time">0.00</span>s</div>
            <div>BEST: <span id="best">0.00</span>s</div>
        </div>
        <div id="ui-center">
            <div id="msg">FINGER BALANCE</div>
            <button id="start-btn" style="display:none;">START</button>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const timeDisplay = document.getElementById('time');
        const bestDisplay = document.getElementById('best');
        const msgDisplay = document.getElementById('msg');
        const startBtn = document.getElementById('start-btn');
        const loading = document.getElementById('loading');

        let width, height;
        let fingerX = 0, fingerY = 0, lastFingerX = 0;
        let poleAngle = 0, poleVel = 0;
        let score = 0, bestScore = localStorage.getItem('bestScore') || 0;
        let active = false;
        let startTime = 0;

        bestDisplay.innerText = bestScore;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
        
        hands.onResults(results => {
            loading.style.display = 'none';
            if (results.multiHandLandmarks?.length > 0) {
                const tip = results.multiHandLandmarks[0][8];
                fingerX = (1 - tip.x) * width;
                fingerY = tip.y * height;
                
                if (!active && startBtn.style.display === 'none') {
                    startBtn.style.display = 'inline-block';
                }
            } else if (active) {
                gameOver("LOST FINGER!");
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 1280, height: 720
        });
        camera.start();

        function startGame() {
            active = true;
            score = 0;
            startTime = performance.now();
            poleAngle = (Math.random() - 0.5) * 0.1;
            poleVel = 0;
            msgDisplay.innerText = "";
            startBtn.style.display = 'none';
        }

        startBtn.addEventListener('click', startGame);

        function gameOver(text) {
            active = false;
            if (parseFloat(score) > parseFloat(bestScore)) {
                bestScore = score;
                localStorage.setItem('bestScore', bestScore);
                bestDisplay.innerText = bestScore;
            }
            msgDisplay.innerText = text;
            startBtn.innerText = "RETRY";
            startBtn.style.display = 'inline-block';
        }

        function draw() {
            // 前のフレームを消去（背景がカメラなので完全に透明にする）
            ctx.clearRect(0, 0, width, height);

            if (active) {
                score = ((performance.now() - startTime) / 1000).toFixed(2);
                timeDisplay.innerText = score;

                // 物理計算
                let grav = 0.004 + (score * 0.0001);
                poleVel += Math.sin(poleAngle) * grav;
                poleVel -= (fingerX - lastFingerX) * 0.002;
                poleVel *= 0.98;
                poleAngle += poleVel;
                lastFingerX = fingerX;

                if (Math.abs(poleAngle) > Math.PI / 2.1) gameOver("OVER!");

                // 棒の描画（ネオン効果を最大化）
                const ex = fingerX + Math.sin(poleAngle) * 300;
                const ey = fingerY - Math.cos(poleAngle) * 300;

                // 外側の光
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#0ff';
                ctx.strokeStyle = '#0ff';
                ctx.lineWidth = 12;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(fingerX, fingerY);
                ctx.lineTo(ex, ey);
                ctx.stroke();

                // 内側の白い芯
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();

                // 先端の赤いランプ
                ctx.fillStyle = '#f00';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#f00';
                ctx.beginPath();
                ctx.arc(ex, ey, 10, 0, Math.PI * 2);
                ctx.fill();
            }

            // 指先のターゲット
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#0ff';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(fingerX, fingerY, 25, 0, Math.PI * 2);
            ctx.stroke();

            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
