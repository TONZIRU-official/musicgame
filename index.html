<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Hand Shooter - Virus Buster v2</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; }
    canvas { position: absolute; transform: scaleX(-1); width: 100vw; height: 100vh; object-fit: cover; }
    #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: #0f0; z-index: 10; pointer-events: none; text-shadow: 0 0 10px #0f0; }
    #score { font-size: 40px; }
    #msg { font-size: 18px; color: white; }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 100px rgba(0,255,0,0.2); pointer-events: none; }
  </style>
</head>
<body>

<div id="ui">
  <div id="score">SCORE: 0</div>
  <div id="msg">人差し指を立てて狙え！（他の指は閉じる）</div>
</div>
<div class="overlay"></div>

<video id="input_video" style="display:none;"></video>
<canvas id="output_canvas"></canvas>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const scoreElement = document.getElementById('score');

  let score = 0;
  let enemies = [];
  let bullets = [];
  let frameCount = 0;

  function spawnEnemy() {
    enemies.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      size: 30 + Math.random() * 40,
      color: `hsl(${Math.random() * 60}, 100%, 50%)` // 赤〜黄色系の色
    });
  }

  function onResults(results) {
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks) {
      for (const landmarks of results.multiHandLandmarks) {
        // --- 指の判定ロジック ---
        // Y座標は「上が小さく、下が大きい」
        const isIndexUp = landmarks[8].y < landmarks[6].y;   // 人差し指が立っている
        const isMiddleDown = landmarks[12].y > landmarks[10].y; // 中指が寝ている
        const isRingDown = landmarks[16].y > landmarks[14].y;   // 薬指が寝ている

        // 人差し指だけが立っている時のみ実行
        if (isIndexUp && isMiddleDown && isRingDown) {
          const tip = landmarks[8];
          const fx = tip.x * canvasElement.width;
          const fy = tip.y * canvasElement.height;

          // 照準描画
          canvasCtx.strokeStyle = '#0f0';
          canvasCtx.lineWidth = 5;
          canvasCtx.beginPath();
          canvasCtx.arc(fx, fy, 25, 0, Math.PI*2);
          canvasCtx.moveTo(fx - 35, fy); canvasCtx.lineTo(fx + 35, fy);
          canvasCtx.moveTo(fx, fy - 35); canvasCtx.lineTo(fx, fy + 35);
          canvasCtx.stroke();

          // 弾の発射
          if (frameCount % 4 === 0) {
            bullets.push({ x: fx, y: fy, r: 5, color: '#0f0' });
          }
        }
      }
    }

    // 弾の更新
    bullets.forEach((b, bi) => {
      b.r += 12;
      canvasCtx.strokeStyle = b.color;
      canvasCtx.globalAlpha = 1 - b.r/120;
      canvasCtx.lineWidth = 2;
      canvasCtx.beginPath();
      canvasCtx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      canvasCtx.stroke();
      if (b.r > 120) bullets.splice(bi, 1);
    });
    canvasCtx.globalAlpha = 1.0;

    // 敵の更新
    if (frameCount % 50 === 0) spawnEnemy();
    enemies.forEach((e, ei) => {
      e.size += 0.6; // 迫りくる速度
      
      // 敵の描画
      canvasCtx.fillStyle = e.color;
      canvasCtx.shadowBlur = 15;
      canvasCtx.shadowColor = e.color;
      canvasCtx.beginPath();
      canvasCtx.arc(e.x, e.y, e.size, 0, Math.PI*2);
      canvasCtx.fill();
      canvasCtx.shadowBlur = 0;

      // 当たり判定
      bullets.forEach((b) => {
        const dist = Math.hypot(e.x - b.x, e.y - b.y);
        if (dist < e.size) {
          enemies.splice(ei, 1);
          score += 100;
          scoreElement.innerText = `SCORE: ${score}`;
        }
      });

      // ゲームオーバー判定
      if (e.size > 220) {
        enemies = [];
        score = 0;
        scoreElement.innerText = `GAME OVER - RESETTING`;
      }
    });

    frameCount++;
    canvasCtx.restore();
  }

  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.75, // 精度を少し上げた
    minTrackingConfidence: 0.75
  });
  hands.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 1280, height: 720
  });
  camera.start();
</script>
</body>
</html>
