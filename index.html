<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Finger Basketball AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #view_video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; opacity: 0.8; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        #ui { position: fixed; top: 20px; left: 20px; color: #fff; z-index: 2; text-shadow: 2px 2px 5px #000; }
        #goal_msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff0; font-size: 80px; display: none; z-index: 3; text-shadow: 0 0 20px #f00; }
    </style>
</head>
<body>
    <video id="view_video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="ui">
        <div style="font-size: 24px;">SCORE</div>
        <div id="score" style="font-size: 60px; color: #ff8000;">0</div>
        <p>指先でボールを弾いてシュート！</p>
    </div>
    <div id="goal_msg">GOAL!!</div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const goalMsg = document.getElementById('goal_msg');
        const viewVideo = document.getElementById('view_video');

        let width, height, score = 0;
        let fingerX = 0, fingerY = 0, lastFingerX = 0, lastFingerY = 0;

        // ボールの物理設定
        let ball = { x: 200, y: 200, vx: 0, vy: 0, radius: 40 };
        const gravity = 0.6;
        const friction = 0.98;
        const bounce = 0.7;

        // ゴールの設定
        const hoop = { x: 0, y: 200, w: 120, h: 10 };

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            hoop.x = width - 200; // 右側に配置
        }
        window.addEventListener('resize', resize);
        resize();

        // MediaPipe Hands 設定
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
        hands.onResults(results => {
            if (results.multiHandLandmarks?.length > 0) {
                const tip = results.multiHandLandmarks[0][8];
                fingerX = (1 - tip.x) * width;
                fingerY = tip.y * height;
            }
        });

        const camera = new Camera(viewVideo, {
            onFrame: async () => await hands.send({image: viewVideo}),
            width: 640, height: 480
        });
        camera.start();

        function update() {
            ctx.clearRect(0, 0, width, height);

            // ボールの物理演算
            ball.vy += gravity;
            ball.vx *= friction;
            ball.vy *= friction;
            ball.x += ball.vx;
            ball.y += ball.vy;

            // 壁と床の衝突
            if (ball.y + ball.radius > height) {
                ball.y = height - ball.radius;
                ball.vy *= -bounce;
            }
            if (ball.x < 0 || ball.x > width) ball.vx *= -bounce;

            // 指との衝突（弾く動作）
            const dx = ball.x - fingerX;
            const dy = ball.y - fingerY;
            const distance = Math.hypot(dx, dy);
            if (distance < ball.radius + 20) {
                // 指の移動速度をボールに伝える
                ball.vx = (fingerX - lastFingerX) * 1.5;
                ball.vy = (fingerY - lastFingerY) * 1.5;
                // 重なり防止
                const angle = Math.atan2(dy, dx);
                ball.x = fingerX + Math.cos(angle) * (ball.radius + 21);
                ball.y = fingerY + Math.sin(angle) * (ball.radius + 21);
            }

            // ゴール判定
            if (ball.vx > 0 && ball.x > hoop.x && ball.x < hoop.x + hoop.w &&
                ball.y > hoop.y && ball.y < hoop.y + 20 && ball.vy > 0) {
                showGoal();
            }

            // ゴールの描画（バックボードとリング）
            ctx.lineWidth = 8;
            ctx.strokeStyle = '#ff0000';
            ctx.strokeRect(hoop.x, hoop.y, hoop.w, hoop.h);
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(hoop.x + hoop.w, hoop.y - 80, 10, 150); // バックボード

            // ボールの描画
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#ff8000';
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 指先の表示
            ctx.strokeStyle = '#0ff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(fingerX, fingerY, 15, 0, Math.PI * 2);
            ctx.stroke();

            lastFingerX = fingerX;
            lastFingerY = fingerY;
            requestAnimationFrame(update);
        }

        function showGoal() {
            score += 1;
            scoreDisplay.innerText = score;
            goalMsg.style.display = 'block';
            setTimeout(() => { goalMsg.style.display = 'none'; }, 1000);
            // ゴールしたらボールを戻す
            ball.x = 100;
            ball.y = height / 2;
            ball.vx = 0; ball.vy = 0;
        }

        update();
    </script>
</body>
</html>
